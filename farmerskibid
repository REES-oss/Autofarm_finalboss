local RS = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local VirtualUser = game:GetService("VirtualUser")
local LocalPlayer = Players.LocalPlayer

getgenv().mainName = getgenv().mainName or ""

local AltResetEvent = RS:FindFirstChild("AltResetEvent")
if not AltResetEvent then
    AltResetEvent = Instance.new("RemoteEvent")
    AltResetEvent.Name = "AltResetEvent"
    AltResetEvent.Parent = RS
end

local MAIN_CFRAME = CFrame.new(1063, 406, 23006)
local ALT_CFRAME  = CFrame.new(1063, 406, 22996)

LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

task.spawn(function()
    while task.wait(0.25) do
        local char = LocalPlayer.Character
        if char then
            local comm = char:FindFirstChild("Communicate")
            if comm then
                pcall(function()
                    comm:FireServer({Goal = "Emote Spin"})
                end)
            end
        end
    end
end)

local function getChar()
    return LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
end

local function getRoot()
    return getChar():WaitForChild("HumanoidRootPart")
end

local function tp(cf)
    getRoot().CFrame = cf
end

local function resetChar()
    getChar():WaitForChild("Humanoid").Health = 0
end

local function getPlayerByName(name)
    for _, p in ipairs(Players:GetPlayers()) do
        if p.Name == name then
            return p
        end
    end
end

local mainPlayer = getPlayerByName(getgenv().mainName)
if not mainPlayer then return end
local isMain = LocalPlayer.Name == getgenv().mainName

LocalPlayer.CharacterAdded:Connect(function()
    task.wait()
    if isMain then
        tp(MAIN_CFRAME)
    else
        tp(ALT_CFRAME)
    end
end)

if isMain then
    local altSignal = false
    AltResetEvent.OnClientEvent:Connect(function()
        altSignal = true
    end)

    task.spawn(function()
        while true do
            while not altSignal do
                task.wait(0.1)
            end
            altSignal = false
            local char = getChar()
            local tool = char:FindFirstChild("Scatter") or LocalPlayer.Backpack:FindFirstChild("Scatter")
            if tool then
                tool.Parent = char
                task.wait(0.15)
                tool:Activate()
                task.wait(0.5)
            end
            resetChar()
            LocalPlayer.CharacterAdded:Wait()
            tp(MAIN_CFRAME)
            task.wait(0.2)
        end
    end)
else
    task.spawn(function()
        while true do
            tp(ALT_CFRAME)
            task.wait(0.2)
            resetChar()
            AltResetEvent:FireServer()
            LocalPlayer.CharacterAdded:Wait()
            tp(ALT_CFRAME)
            task.wait(0.2)
        end
    end)
end
