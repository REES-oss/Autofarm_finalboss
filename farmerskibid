local RS = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local VirtualUser = game:GetService("VirtualUser")
local LocalPlayer = Players.LocalPlayer

getgenv().mainName = getgenv().mainName or ""

local AltResetEvent = RS:FindFirstChild("AltResetEvent")
if not AltResetEvent then
    AltResetEvent = Instance.new("RemoteEvent")
    AltResetEvent.Name = "AltResetEvent"
    AltResetEvent.Parent = RS
end

local MAIN_CFRAME = CFrame.new(1063, 406, 23006)
local ALT_CFRAME  = CFrame.new(1063, 406, 22996)

LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

local function getChar()
    return LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
end

local function getRoot()
    return getChar():WaitForChild("HumanoidRootPart")
end

local function tp(cf)
    local root = getRoot()
    if root then
        root.CFrame = cf
    end
end

local function resetChar()
    local char = getChar()
    local humanoid = char:FindFirstChild("Humanoid")
    if humanoid then
        humanoid.Health = 0
    end
end

local function getPlayerByName(name)
    for _, p in ipairs(Players:GetPlayers()) do
        if p.Name == name then
            return p
        end
    end
end

local mainPlayer = getPlayerByName(getgenv().mainName)
if not mainPlayer then return end
local isMain = LocalPlayer.Name == getgenv().mainName

LocalPlayer.CharacterAdded:Connect(function()
    task.wait(0.1)
    if isMain then
        tp(MAIN_CFRAME)
    else
        tp(ALT_CFRAME)
    end
end)

if isMain then
    local altSignal = false
    AltResetEvent.OnClientEvent:Connect(function()
        altSignal = true
    end)

    task.spawn(function()
        while true do
            local char = getChar()
            tp(MAIN_CFRAME)

            while not altSignal do
                task.wait(0.1)
            end
            altSignal = false

            char = getChar()
            tp(MAIN_CFRAME)

            local tool = LocalPlayer.Backpack:FindFirstChild("Scatter") or char:FindFirstChild("Scatter")
            if tool then
                tool.Parent = char
                task.wait(0.2) -- small wait to ensure tool is recognized
                pcall(function()
                    tool:Activate()
                end)
                task.wait(0.5) -- wait to ensure tool action completes
            end

            resetChar()
            LocalPlayer.CharacterAdded:Wait()
            tp(MAIN_CFRAME)
            task.wait(0.2)
        end
    end)
else
    task.spawn(function()
        while true do
            tp(ALT_CFRAME)
            task.wait(0.2)
            resetChar()
            AltResetEvent:FireServer()
            LocalPlayer.CharacterAdded:Wait()
            tp(ALT_CFRAME)
            task.wait(0.2)
        end
    end)
end
